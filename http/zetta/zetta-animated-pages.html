<dom-module id="zetta-animated-page">
	<style>:host{display: block;}</style>
	<template>
		<content></content>
	</template>
	<script>
		Polymer({
			is:'zetta-animated-page'
		})
	</script>
</dom-module>
<dom-module id="zetta-animated-pages">
	<style>
		:host{
			overflow-y: auto;
			display: block;
			outline: 0px;
		}
		:host(#pages){
			overflow-y: auto;
			display: block;
		}
	</style>
	<template>
		<content></content>
	</template>
	<script>
		Polymer({
			is:'zetta-animated-pages',
			properties:{
				selected: {
					type: Number,
					value: false,
					notify: true,
					observer: 'onSelectedChange'
				},
				items: {
					type: Array,
					value:[],
					observer: 'onItemChange'
				},
				animateTime: {
					type: Number,
					value: 800
				},
				noAnimationForFirst:{
					type: Boolean,
					value: false
				},
				fixMinHeight:{
					type: Boolean,
					value: false
				},
				tabindex:{
					type:Number,
					value:1,
					reflectToAttribute: true
				},
				dontAutoFocus:{
					type: Boolean,
					value: false,
					observer:'_onAutoFocusChanged'
				}
			},
			ready: function(){
				var self = this;
				self.listen(window, 'resize', 'setMinHeightOfChildren');
				self.listen(self, 'scroll', 'onScroll');
				
				self._isReady = true;

				if(!ZETTA._locationHash){
					self.onSelectedChange();
				}
			},
			getLocationHash: function(){
				return window.location.hash;
			},
			setLocationHash:function(hash){
				if (!hash){
					window.location.hash = "";
					return;
				}
				window.location.hash = hash;
			},
			_onAutoFocusChanged: function(){
				var self = this;
				if (!self.dontAutoFocus) {
					self.addDocListener();
				}else{
					self.removeDocListener();
				}
			},
			addDocListener: function(){
				this._onDocumentKeyPress = this.onDocumentKeyPress.bind(this);
				document.addEventListener('keyup', this._onDocumentKeyPress);
			},
			removeDocListener: function(){
				this._onDocumentKeyPress && document.removeEventListener('keyup', this._onDocumentKeyPress);
			},

			onDocumentKeyPress: function(e){
				var self = this;
				var t = e.target;
				if(
					t == self ||
					t.parentNode == self ||
					(t.parentNode && t.parentNode.parentNode == self) ||
					(t.tagName == 'PAPER-TAB' || t.tagName == 'BODY' || t.tagName == 'HTML')
					){
					self.tryToFocus();
				}
			},
			tryToFocus:function(){
				var self = this;
				if (!self.dontAutoFocus && self.focus) {
					self.focus();
				};
			},
			onItemChange: function(){
				if(!this.getLocationHash())
					this.onSelectedChange();
			},
			onSelectedChange: function(){
				var self = this;
				if (ZETTA._locationHash) {
					return;
				};
				//console.log("onSelectedChange", ZETTA._locationHash, arguments)
				if (self.selected === false || !self._isReady || !self.items.length)
					return;
				if (self._selected === self.selected) {
					self._selected = false;
					return;
				};
				self._selected = false;
				if (self.noAnimationForFirst && !self.__initChange) {
					self.__initChange = true;
					self.scrollTop = self.getItemTop(self.selected);
				}else{
					self.animating = true;
					jQuery(self).stop(true, false).animate({
						scrollTop: self.getItemTop(self.selected) || 1
					}, {
						duration: self.animateTime,
						always: function(){
							self.animating = false;
						}
					})
				}
			},
			onScroll: function(e){
				//console.log("zetta-animated-pages", this.scrollTop)
				var self = this;
				if (self.animating)
					return;
				self.debounce('onScroll', function(){
					self.updateSelected();
					(e.target == self) && self.tryToFocus();
				}, 300);
			},

			updateSelected: function(){
				var self = this;
				var top = self.scrollTop;
				var selected = 0;
				_.each(self.items, function(page, index){
					if (page.offsetTop <= top ) {
						selected = index;
					};
				});
				//console.log('updateSelected', selected)
				self.setSilentSelected(selected);
			},

			setSilentSelected: function(selected){
				var self = this;
				self._selected = selected;
				self.set('selected', selected);
				//self.async(function(){
					//self._silentSelected = false;
				//}, 100)
			},

			getItemTop: function(index){
				var self = this;
				var page = self.items ? self.items[index] : false;
				if (!page) {
					return self.scrollTop;
				};
				return page.offsetTop;
			},
			attached: function() {
				var self = this;
				self.async(function(){
					self.initItems();
					if (!self.dontAutoFocus) {
						self.tryToFocus();
					}
				}, 10);
			},
			initItems: function() {
				var self = this;
				self.set('items', self.getChildren());
				self.setMinHeightOfChildren();
				if(ZETTA._locationHash){
					self.async(function(){
						self.updateSelected();
					}, 10);
				}
			},
			setMinHeightOfChildren: function(){
				var self = this;
				if (!self.fixMinHeight)
					return;
				var minHeight = self.getBoundingClientRect().height;
				_.each(self.items, function(child){
					child.style.minHeight = minHeight+'px'; 
				});
			},
			getChildren: function(){
				return this.querySelectorAll('zetta-animated-page');
			}
		})
	</script>
</dom-module>

