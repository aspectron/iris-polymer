<script>
	function log(){
		if (arguments[0].tagName){
			var tagName = arguments[0].tagName+":";
			arguments = Array.prototype.slice.call(arguments, 1);
			arguments.unshift(tagName)
		}
		console.log.apply(console, arguments)
	};

	var ZETTA = window.ZETTA || {};
	ZETTA.ZettaDomAppBehavior = {
		properties:{
			rpcPath: {
				type: String,
				value: '/rpc'
			},
			rpcHolder:{
				type: String,
				value: ''
			},
			selected:{
				type: Number,
				value: 0,
				notify: true,
				observer: 'selectedChanged'
			},
			leftselected:{
				type: Number,
				value: 1,
				observer: 'leftselectedChanged'
			},
			lefttabs: {
				type: Array,
				value:[],
				notify: true,
				observer: 'subtabChanged'
			},
			logoutPath:{
				type: String,
				value: '/logout'
			},
			logintab:{
				type: String,
				value: 'Login',
				notify: true
			},
			logintask:{
				type: String,
				value: 'login',
				notify: true
			},
			languageselector:{
				type: Boolean,
				observer: 'onLanguageSelectorChange'
			},
			user:{
				type: Object,
				value: {},
				observer: 'onUserChange'
			},
			msg:{
				type: Object,
				value: {},
				observer:'onMsgChange'
			},
			languagetitle:{
				type: String,
				notify: true,
				observer: 'onLanguageTitleChange'
			},
			entryanimation:{
				type: String,
				notify: true,
				value: 'slide-from-right-animation'
			},
			exitanimation:{
				type: String,
				notify: true,
				value: 'slide-left-animation'
			},
			language:{
				type: Object,
				value:{},
				notify: true,
				observer: 'onLanguageChange'
			},
			selectedlang: {
				type: String,
				value: '',
				//observer:'onSelectedlangChange'
			},
			selectedpage: {
				type: Number,
				value: 0,
				notify: true
			}
		},
		listeners:{
			'pages-ready': 'onPagesReady',
			'page-animation-finished': 'onPageAnimationFinished'
		},
		ready: function(){
			var self = this;
			self.rpc 				= self.$.rpc;
			self.selectedpage 		= self.selected;

			self.classList.add('layout');
			self.classList.add('vertical');

			//log(this, self)

			self.tabsAdded = true;
		},

		attached: function(){
			var self = this;
			_.each(['tabs', 'pages'], function(id){
				self.$[id] = self.querySelector('#'+id);
			});

			//self.$.header = self.querySelector('zetta-dom-app-header');
			self.$.content = self.querySelector('.zetta-dom-app-content');

			self.listen(self.$.content, 'dom-change', 'onPagesReady');
			self.listen(self.$.content, 'neon-animation-finish', 'onPageAnimationFinished');

			//self.updateLanguageTitle(self.language.locale);
			self.tabsAdded = true;
		},

		onUserChange: function(user){
			var self = this;
			self.logintab 			= self.user ? 'Logout': 'Login';
			self.logintask 			= self.user ? 'logout': 'login';
		},

		onMsgChange: function(msg){
		},

		onLanguageSelectorChange: function(){
			//if(this.$.header)
				//this.$.header.languageselector = this.languageselector;
		},

		onLanguageTitleChange: function(){
			//if(this.$.header){
				//this.$.header.languagetitle = this.languagetitle;
			//}
		},
		onLanguageChange: function(){
			//if(this.$.header){
				//this.$.header.language = this.language;
			//}
		},

		updateLanguageTitle: function(code){
			//this.languagetitle = _.find(this.language.list, function(o){return o.id == code}).name;
			//if(this.$.header){
				//this.$.header.languagetitle = this.languagetitle;
				//this.$.header.language = this.language;
			//}
		},
		/*
		onSelectedlangChange: function(langCode){
			var self = this;
			//var langCode = e.target.dataId
			if (!langCode) {
				return;
			};
			self.updateLanguageTitle(langCode);
			//console.log("self.language.locale", self.language.locale, self.language.source, langCode)
			if (self.language.locale != langCode) {
				var loc = window.location;
				if (self.language.locale == 'en') {
					window.location.href = loc.href.replace(loc.host+'/', loc.host+'/'+langCode+'/');
				}else{
					window.location.href = loc.href.replace(loc.host+'/'+self.language.locale, loc.host+'/'+langCode);
				}
			};
		},
		*/
		leftselectedChanged: function(){
			//console.log("leftselectedChanged", arguments)
		},
		subtabChanged: function(){
			//console.log("subtabChanged", arguments)
            if(this.$.lefttabs)
			    this.$.lefttabs._onResize();
		},
		onPageAnimationFinished: function(){
			//console.log("onPageAnimationFinished")
		},
		onPagesReady: function(){
			var self = this;
			self.debounce('onPagesReady', function(){
				if(self.tabsAdded){
					self.restoreLastTab();
					self.tabsAdded = false;
				}
			}, 200);
		},
		getTab: function(id){
			var self = this;
			var tabs = self.$.tabs.querySelectorAll('paper-tab');
			var tab = {};
			_.each(tabs, function(t, index){
				if (t.dataTabId == id || t.getAttribute('data-tab-id') == id){
					tab.tab = t;
					tab.index = index;
				}
			});
			return tab;
		},
		toUpperCase : function(v) {
			return (v+'').toUpperCase();
		},
		toLowerCase : function(v) {
			return (v+'').toLowerCase();
		},
		showHome : function() {
			var self = this;
			self.selected = 0;
		},
		selectedChanged:function(newValue, oldValue){
			var self = this;
			if (!self.$.tabs || !self.$.tabs.items) {
				return log(this, "Tabs missing");
			};
			if (oldValue !== undefined && newValue > oldValue) {
				self.entryanimation = 'slide-from-right-animation';
				self.exitanimation = 'slide-left-animation';
			}else{
				self.entryanimation = 'slide-from-left-animation';
				self.exitanimation = 'slide-right-animation';
			}
			
			var tab = self.$.tabs.items[self.selected].dataTab;
			if ( tab == 'logout') {
				window.location.href = self.logoutPath;
				return;
			};
			self.selectedpage = self.selected;
			self.$.pages.fire('neon-animation-begin');
			if (oldValue !== undefined && tab!='login') {
				localStorage.tabIndex = self.selected;
			}
		},
		restoreLastTab: function(){
			if (this.msg && this.msg.activation){
				this.selected = this.getTab('login').index;
				return;
			}
			if(typeof localStorage.tabIndex != 'undefined'){
				this.selected = parseInt(localStorage.tabIndex);
			}
		}
	};
</script>

