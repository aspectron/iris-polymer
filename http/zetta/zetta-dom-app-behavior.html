<script>
	function log(){
		if (arguments[0].tagName){
			var tagName = arguments[0].tagName+":";
			arguments = Array.prototype.slice.call(arguments, 1);
			arguments.unshift(tagName)
		}
		console.log.apply(console, arguments)
	};

	window.ZETTA = window.ZETTA || {};
	window.ZETTA.ZettaDomAppBehavior = {
		properties:{
			appName: {
				type: String,
				value: ''
			},
			mediaquery:{
				type: String,
				value: 'max-width: 768px'
			},
			isnarrow: {
				type: Boolean,
				observer: 'onNarrowChange'
			},
			ismobile:{
				type: Boolean,
				value: false,
				notify: true,
				observer: 'isMobileChanged'
			},
			rpcPath: {
				type: String,
				value: '/rpc'
			},
			rpcHolder:{
				type: String,
				value: ''
			},
			selected:{
				type: Number,
				value: 0,
				notify: true,
				observer: 'selectedChanged'
			},
			leftselected:{
				type: Number,
				value: 0,
				observer: 'leftselectedChanged'
			},
			lefttabs: {
				type: Array,
				value:[],
				notify: true,
				observer: 'subtabChanged'
			},
			logoutPath:{
				type: String,
				value: '/logout'
			},
			logintab:{
				type: String,
				value: 'Login',
				notify: true
			},
			logintask:{
				type: String,
				value: 'login',
				notify: true
			},
			languageselector:{
				type: Boolean,
				observer: 'onLanguageSelectorChange'
			},
			user:{
				type: Object,
				observer: 'onUserChange'
			},
			msg:{
				type: Object,
				value: {},
				observer:'onMsgChange'
			},
			languagetitle:{
				type: String,
				notify: true,
				observer: 'onLanguageTitleChange'
			},
			entryanimation:{
				type: String,
				notify: true,
				value: 'slide-from-right-animation'
			},
			exitanimation:{
				type: String,
				notify: true,
				value: 'slide-left-animation'
			},
			language:{
				type: Object,
				value:{},
				notify: true,
				observer: 'onLanguageChange'
			},
			selectedlang: {
				type: String,
				value: '',
				//observer:'onSelectedlangChange'
			},
			selectedpage: {
				type: Number,
				value: 0,
				notify: true
			},
			verticalanimation: Boolean
		},
		listeners:{
			'pages-ready': 'onPagesReady',
			'drawerMenus.click': 'onDrawerMenuItemClick',
			'page-animation-finished': 'onPageAnimationFinished'
		},
		ready: function(){
			var self = this;
			self.rpc 				= self.$.rpc;
			//self.selectedpage 		= self.selected;

			self.classList.add('layout');
			self.classList.add('vertical');

			//log(this, self)

			self.tabsAdded = true;
			ZETTA.loadTheme('theme1.html');
		},

		attached: function(){
			var self = this;
			_.each(['tabs', 'pages', 'lefttabs'], function(id){
				self.$[id] = self.querySelector('#'+id);
			});

			//self.$.header = self.querySelector('zetta-dom-app-header');
			self.$.content = self.querySelector('.zetta-dom-app-content');
			self.$.toggleDrawerBtns = self.querySelectorAll('[toggle-drawer]');
			_.each(self.$.toggleDrawerBtns, function(btn){
				self.listen(btn, 'click', 'toggleDrawer');
			})

			self.listen(self.$.content, 'dom-change', 'onPagesReady');
			self.listen(self.$.content, 'neon-animation-finish', 'onPageAnimationFinished');

			//self.updateLanguageTitle(self.language.locale);
			self.tabsAdded = true;
		},

		toUpperCase : function(v) {
			return (v+'').toUpperCase();
		},
		toLowerCase : function(v) {
			return (v+'').toLowerCase();
		},

		onNarrowChange: function(){
			console.log("onNarrowChange", this.isnarrow)
		},

		isMobileChanged:function(ismobile){
			var self = this;
			console.log("ismobile", ismobile)
			this.toggleClass('mobile', ismobile);
			if (!self.$.tabs){
				self._isMobileChangedDebounceCount = self._isMobileChangedDebounceCount || 0;
				self._isMobileChangedDebounceCount++;
				if (self._isMobileChangedDebounceCount > 20) {
					return;
				};
				self.debounce('isMobileChanged', function(){
					self.isMobileChanged(self.ismobile);
				}, 100);
				return;
			}
			self._isMobileChangedDebounceCount = 0;
			if(!self._tabsParent){
				self._tabsParent = self.$.tabs.parentNode;
			}
			var drawerMenuItems = self.querySelectorAll('.drawer-menu');
			_.each(drawerMenuItems, function(menu){
				if (!menu.__pNode){
					menu.__pNode = menu.parentNode;
				}
			})

			if (ismobile){
				self.$.drawerMenus.appendChild(self.$.tabs);
				_.each(drawerMenuItems, function(menu){
					self.$.drawerMenus.appendChild(menu);
				});
			}else{
				self._tabsParent.appendChild(self.$.tabs);
				_.each(drawerMenuItems, function(menu){
					menu.__pNode.appendChild(menu)
				})
			}
			//self.$.tabs.selected = self.selected;
		},
		onDrawerMenuItemClick:function(e){
			var self = this;
			var tab = _.find(e.path, function(t){return t.tagName == 'PAPER-TAB'});
			if (!tab || !tab.hasAttribute)
				return;
			var dontHide = tab.hasAttribute('dont-hide') || (tab.classList && tab.classList.contains('dont-hide'));
			if (dontHide) {
				return;
			};
			self.toggleDrawer();
		},
		onUserChange: function(user){
			var self = this;
			console.log("onUserChange", self.user, self.get('user'), user);
			self.set('logintab', self.get('user') ? 'Logout': 'Login');
			self.set('logintask',  self.get('user') ? 'logout': 'login');
		},

		onMsgChange: function(msg){
		},

		onLanguageSelectorChange: function(){
		},

		onLanguageTitleChange: function(){
		},
		onLanguageChange: function(){
			//if(this.$.header){
				//this.$.header.language = this.language;
			//}
		},

		updateLanguageTitle: function(code){
		},
		leftselectedChanged: function(){
		},
		subtabChanged: function(){
			var self = this;
			//console.log("subtabChanged", arguments, self.$.lefttabs)
			if (!self.$.lefttabs) {
				self.$.lefttabs = self.querySelector('#lefttabs');
			}
            if(self.$.lefttabs)
			    self.$.lefttabs._onResize();
		},
		onPageAnimationFinished: function(){
			//console.log("onPageAnimationFinished")
		},
		onPagesReady: function(){
			var self = this;
			self.debounce('onPagesReady', function(){
				if(self.tabsAdded){
					self.restoreLastTab();
					self.tabsAdded = false;
				}
			}, 200);
		},
		getTab: function(id){
			var self = this;
			var tabs = self.$.tabs.querySelectorAll('paper-tab');
			var tab = {};
			_.each(tabs, function(t, index){
				if (t.dataTabId == id || t.getAttribute('data-tab-id') == id){
					tab.tab = t;
					tab.index = index;
				}
			});
			return tab;
		},
		getActiveTabId: function(){
			var self = this;
			var seletedTab = self.$.tabs && self.$.tabs.items[self.get('selected')];
			if (!seletedTab){
				return false;
			}
			return seletedTab.dataTabId || seletedTab.getAttribute('data-tab-id');
		},
		toUpperCase : function(v) {
			return (v+'').toUpperCase();
		},
		toLowerCase : function(v) {
			return (v+'').toLowerCase();
		},
		showHome : function() {
			var self = this;
			self.selected = 0;
		},
		selectedChanged:function(newValue, oldValue){
			var self = this;
			if (!self.$.tabs || !self.$.tabs.items) {
				return log(this, "Tabs missing");
			};
			if (self.verticalanimation) {
				if (oldValue !== undefined && newValue > oldValue) {
					self.entryanimation = 'slide-from-down-animation';
					self.exitanimation = 'slide-up-animation';
				}else{
					self.entryanimation = 'slide-down-animation';
					self.exitanimation = 'slide-from-up-animation';
				}
			}else{
				if (oldValue !== undefined && newValue > oldValue) {
					self.entryanimation = 'slide-from-right-animation';
					self.exitanimation = 'slide-left-animation';
				}else{
					self.entryanimation = 'slide-from-left-animation';
					self.exitanimation = 'slide-right-animation';
				}
			}
			var seletedTab = self.$.tabs.items[self.selected];
			if (!seletedTab){
				self.selectedpage = 0;
				return;
			}
			var tab = seletedTab.dataTab || seletedTab.getAttribute('data-tab');
			if ( tab == 'logout') {
				window.location.href = self.logoutPath;
				return;
			};
			self.selectedpage = self.selected;
			self.$.pages.fire('neon-animation-begin');
			if (oldValue !== undefined && tab!='login') {
				self.localStorage('tabIndex', self.selected);
			}
		},
		restoreLastTab: function(){
			var self = this;
			if (this.msg && this.msg.activation){
				this.selected = this.getTab('login').index;
				return;
			}
			var tabIndex = self.localStorage('tabIndex');
			if(typeof  tabIndex != 'undefined'){
				this.selected = parseInt(tabIndex);
			}
		},
		toggleDrawer: function(){
			this.$.drawer.togglePanel();
		},
		localStorage: function(key, value){
			var self = this;
			key = (self.appName || 'app').toLowerCase()+'-'+key;
			if (arguments.length == 1)
				return localStorage[key];

			if (value === undefined){
				value = localStorage[key];
				delete localStorage[key];
				return value;
			}

			localStorage[key] = value;
			return value;
		}
	};
</script>

