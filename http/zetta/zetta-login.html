<link rel="import" href="/deps/iron-flex-layout/iron-flex-layout.html" />
<link rel="import" href="/deps/neon-animation/neon-animation.html" />
<link rel="import" href="/deps/paper-input/paper-input.html" />
<link rel="import" href="/deps/paper-button/paper-button.html" />
<link rel="import" href="/deps/paper-tabs/paper-tabs.html" />

<dom-module id="zetta-login" attributes="msg entryAnimation exitAnimation passrecoveryurl">
	<style>
		.form-ctr{
			font-size: 14px;
			font-family: "Droid Sans Mono";
			background-color: white;
			text-align: left;
			min-width: 250px;
			display: block;
		}
		form{
			padding: 25px;
			margin: 16px;
			@apply(--shadow-elevation-4dp);
			width: 300px;
			display: block;
		}
		.hide{display: none}
		h2{margin-top: 0px;}
		.checkbox-container{margin: 5px 0px 15px;}
		.submit{margin-left: 0px; margin-bottom: 10px;}
		.msg{min-height: 25px; color: #F00; font-size: 12px; margin-bottom:5px;}
		.msg.success{color: #3169F5;}
		a{cursor:  pointer;}
		.align-right{float: right}
	</style>
	<template>
		<neon-animated-pages on-dom-change="onPagesReady" selected="[[selectedPage]]" class="flex" entry-animation="[[entryAnimation]]" exit-animation="[[exitAnimation]]">
			<neon-animatable>
				<div class="horizontal layout center-center">
					<form id="loginform" on-submit="submit" role="form">
						<h2><%= _T("Login") %></h2>
						<paper-input class="form-ctr" on-keypress="onKeyPress" name="username" label="<%= _T("E-Mail") %>" value="{{username}}" required></paper-input>
						<paper-input class="form-ctr" on-keypress="onKeyPress" name="password" label="<%= _T("Password") %>" value="{{password}}" required></paper-input>
						<div class="form-group hide" id="totpdialog">
							<paper-input class="form-ctr" name="totp" tabindex="3" on-keypress="onKeyPress" label="<%= _T("One time password") %>" value="{{totp}}"></paper-input>
						</div>
						<div id="status" class="msg"></div>
						<div class="checkbox-container">
							<input type="checkbox" tabindex="4" class="" name="remember" id="remember">
							<label for="remember"><%= _T("Remember Me") %></label>
						</div>
						<paper-button on-click="submit" tabindex="4" raised class="submit primary"><%= _T("Log In") %></paper-button>
						<div>
							<a href="{{passrecoveryurl}}" tabindex="5" class="forgot-password"><%= _T("Forgot Password?") %></a>
							<a tabindex="6" class="align-right" on-click="showRegisterForm"><%= _T("Register") %></a>   
						</div>
					</form>
				</div>
			</neon-animatable>
			<neon-animatable>
				<div class="horizontal layout center-center">
					<form id="registerform" on-submit="submitRegister" role="form">
						<h2><%= _T("Register") %></h2>
						<paper-input class="form-ctr" on-keypress="onKeyPressR" type="email" name="usernameRegister" label="<%= _T("E-Mail") %>" value="{{usernameRegister}}" required></paper-input>
						<paper-input class="form-ctr" on-keypress="onKeyPressR" name="passwordRegister" label="<%= _T("Password") %>" value="{{passwordRegister}}" required></paper-input>
						<div id="statusRegister" class="msg"></div>
						<paper-button on-click="submitRegister" tabindex="4" raised class="submit primary"><%= _T("Register") %></paper-button>
						<div>
							<a on-click="showLoginForm"><%= _T("Cancel") %></a>
						</div>
					</form>
				</div>
			</neon-animatable>
		</neon-animated-pages>
	</template>
	<script>
		Polymer({
			is:"zetta-login",
			username: "",
			password: "",
			totp:"",
			timeIntervalId: false,
			entryAnimation: 'slide-from-right-animation',
			exitAnimation: 'slide-left-animation',
			progressImg: '<center><img src="data:image/gif;base64,R0lGODlhEgAEAKECAAAAAH9/f////////yH/C05FVFNDQVBFMi4wAwEAAAAh+QQJDwABACwAAAAAEgAEAAACB4yPqcvtrwoAIfkECQ8AAAAsAAAAABIABAAAAgyMA6m7hwyTi3FSVgAAIfkECQ8AAgAsAAAAABIABAAAAhGEIRkb6XmQYs9Fx1oVd64tFAAh+QQJDwADACwAAAAAEgAEAAACEYQxeZjhsdKI7dF55INZ9bEVACH5BAkPAAMALAAAAAASAAQAAAIRjDMJCzkMDlLMQWkrXXg3XwAAIfkECQ8AAwAsAAAAABIABAAAAhGcP6Fx4IDOYubBmFZ7OKvtFAAh+QQJDwADACwAAAAAEgAEAAACDJyPGBvpx9pzcVJWAAA7"/></center>',
			properties:{
				msg: {
					type: Object,
					value:{},
					observer: 'onMsgChange'
				},
				passrecoveryurl:{
					type: String,
					value: '/password-recovery'
				}
			},

			ready: function(){
				var self = this;
				self.setAnimation('right');
				self.selectedPage = 0;
			},

			onMsgChange: function(newValue){
				var self = this;
				if (newValue && newValue.activation && _.isArray(newValue.activation)){
					var isSuccess = newValue.activation[0].success;
					var msg = '<%= _T("Activation completed. Now you can login.") %>';
					if (!isSuccess) {
						var err = newValue.activation[0].error;
						if (_.isString(err)) {
							msg = err;
						}else if (err.error) {
							msg = err.error;
						}else{
							msg = '<%= _T("Error in account activation") %>';
						}
					};
					self.showMsg('login', msg, isSuccess);
				}
			},

			setAnimation: function(enterFrom){
				var self = this;
				if (enterFrom == 'right') {
					self.entryAnimation = 'slide-from-right-animation';
					self.exitAnimation 	= 'slide-left-animation';
				}else{
					self.entryAnimation = 'slide-from-left-animation';
					self.exitAnimation 	= 'slide-right-animation';
				}
			},

			onPagesReady: function(){

			},

			showRegisterForm: function(){
				var self = this;
				self.setAnimation('right');
				self.selectedPage = 1;
			},

			showLoginForm: function(){
				var self = this;
				self.setAnimation('left');
				self.selectedPage = 0;
			},

			_doFakeSubmitForValidation: function(form) {
				var self = this;
				form = form || 'loginform';
				var fakeSubmit = document.createElement('input');
				fakeSubmit.setAttribute('type', 'submit');
				fakeSubmit.style.display = 'none';
				self.$[form].appendChild(fakeSubmit);

				fakeSubmit.click();

				self.$[form].removeChild(fakeSubmit);
			},

			isValid: function(form){
				var self = this;
				form = form || 'loginform';
				if (form == 'loginform') {
					return self.username && self.password;
				}else if(form == 'registerform'){
					return self.usernameRegister && self.passwordRegister;
				}
			},

			showMsg: function(frm, msg, addSuccessClass){
				var self = this;
				var el = self.$.status;
				if (frm == 'register')
					el = self.$.statusRegister;
				self.toggleClass('success', addSuccessClass, el);
				el.innerHTML = msg;
			},

			submitRegister: function(){
				var self = this;
				if (!self.isValid('registerform')) {
					return self._doFakeSubmitForValidation('registerform');
				};
				var user = self.usernameRegister;
				var pass = self.passwordRegister;
				var totp = self.totpRegister;
				self.showMsg('register', self.progressImg, false);
				window.loginClient.register({username: user, email: user, password: pass, totpToken: totp}, function(err, result) {
					var message = '<%= _T("Server Error") %>';
					var success = false;
					if (err) {
						message = err.error || err;
					}else if(result && result.success){
						if (result.activationRequired) {
							message = '<%= _T("We have send you activation email. Please check your inbox or spam folder.") %>';
						}else{
							message = result.message || '<%= _T("Acccount Created.") %>';
						}
						success = true;
					}

					self.showMsg('register', message, success);
					console.log(arguments);
				});
			},

			submit: function() {
				console.log("submit")
				var self = this;
				if (!self.isValid()) {
					return self._doFakeSubmitForValidation();
				};
				var user = self.username;
				var pass = self.password;
				var totp = self.totp;
				self.showMsg('login', self.progressImg, false);
				window.loginClient.login({username: user, password: pass, totpToken: totp}, function(err, ack) {
					console.log(arguments);
					if(err) {
						if (err.request == 'TOTP') {
							self.toggleClass('hide', false, self.$.totpdialog);
							self.$.status.innerHTML = "";
							return false;
						}
						var message = err.error || err || '<%= _T("Server Error") %>';
						if (err.throttle && err.ts) {
							var totalSec = err.ts;
							 self.clearIntervalId();

							self.timeIntervalId = setInterval(function(){
								totalSec--;

								if (totalSec <=0) {
									self.clearIntervalId();
									self.$.status.innerHTML = "";
									return
								};

								var min = Math.floor(totalSec / 60);
								var sec = totalSec - (min*60);

								self.$.status.innerHTML = '<%= _T("Your access to the login system remains blocked for %min% min %sec% sec") %>'.replace('%min%', min).replace('%sec%', sec);
							}, 1000);
						}
						return self.$.status.innerHTML = err.error || err || '<%= _T("Server Error") %>';
					}

					if(ack){
						console.log("login ok")
						//window.location.href = '';
					}
				});

				return false
			},
			onKeyPressR: function(event){
				if(event.which == 13){
					this.submitRegister();
				}
				return false
			},
			onKeyPress: function(event){
				if(event.which == 13){
					this.submit();
				}
				return false
			},
			clearIntervalId: function (){
				if (this.timeIntervalId) {
					clearInterval(this.timeIntervalId);
				}
			}
		});
	</script>
</dom-module>

